<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.70">
<link rel="alternate" type="application/rss+xml" href="/vsync/blog/rss.xml" title="vsync Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/vsync/blog/atom.xml" title="vsync Blog Atom Feed"><title data-react-helmet="true">Destination | vsync</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Destination | vsync"><meta data-react-helmet="true" name="description" content="This is the end of the unidirectional connection for syncing secrets. It should point to secondary vault clusters in different regions from which regional apps can pull out secrets."><meta data-react-helmet="true" property="og:description" content="This is the end of the unidirectional connection for syncing secrets. It should point to secondary vault clusters in different regions from which regional apps can pull out secrets."><meta data-react-helmet="true" property="og:url" content="https://expediagroup.github.io/vsync/docs/internals/destination"><link data-react-helmet="true" rel="shortcut icon" href="/vsync/img/icon.png"><link data-react-helmet="true" rel="canonical" href="https://expediagroup.github.io/vsync/docs/internals/destination"><link rel="stylesheet" href="/vsync/styles.3b088d13.css">
<link rel="preload" href="/vsync/styles.9dba2727.js" as="script">
<link rel="preload" href="/vsync/runtime~main.1cf8b1d1.js" as="script">
<link rel="preload" href="/vsync/main.0097cd37.js" as="script">
<link rel="preload" href="/vsync/1.ef082d72.js" as="script">
<link rel="preload" href="/vsync/2.3ecc4623.js" as="script">
<link rel="preload" href="/vsync/21.7471a55b.js" as="script">
<link rel="preload" href="/vsync/22.f690dbb4.js" as="script">
<link rel="preload" href="/vsync/935f2afb.e5a0c5fa.js" as="script">
<link rel="preload" href="/vsync/17896441.e63cd7f8.js" as="script">
<link rel="preload" href="/vsync/9683d63b.8fa0e549.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_11B0">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/vsync/"><img src="/vsync/img/icon.png" alt="vsync logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/vsync/img/icon.png" alt="vsync logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Vsync</strong></a><a class="navbar__item navbar__link" href="/vsync/docs/getstarted/why">Docs</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ExpediaGroup/vsync" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2N3Q"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_3NWk">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_3NWk">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/vsync/"><img src="/vsync/img/icon.png" alt="vsync logo" class="themedImage_YANc themedImage--light_3CMI navbar__logo"><img src="/vsync/img/icon.png" alt="vsync logo" class="themedImage_YANc themedImage--dark_3ARp navbar__logo"><strong class="navbar__title">Vsync</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/vsync/docs/getstarted/why">Docs</a></li><li class="menu__list-item"><a href="https://github.com/ExpediaGroup/vsync" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_vMrn"><div class="docSidebarContainer_3Ak5" role="complementary"><div class="sidebar_3gvy"><div class="menu menu--responsive thin-scrollbar menu_1yIk"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_1CUI" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">GetStarted</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/getstarted/why">Why</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/getstarted/install">Install</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/getstarted/config">Config</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Deploy</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/deploy/options">Options</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Internals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/vsync/docs/internals/keywords">Keywords</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/vsync/docs/internals/origin">Origin</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/vsync/docs/internals/destination">Destination</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Faq</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/faq/general">General</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/faq/deployment">Deployment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/faq/failures">Failures</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Contribution</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/contribution/build">Build</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/contribution/ci">CI</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/vsync/docs/contribution/goodparts">Good Parts</a></li></ul></li></ul></div></div></div><main class="docMainContainer_2iGs"><div class="container padding-vert--lg docItemWrapper_1bxp"><div class="row"><div class="col docItemCol_U38p"><div class="docItemContainer_a7m4"><article><header><h1 class="docTitle_Oumm">Destination</h1></header><div class="markdown"><p>This is the end of the unidirectional connection for syncing secrets. It should point to secondary vault clusters in different regions from which regional apps can pull out secrets.</p><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="startup"></a>Startup<a class="hash-link" href="#startup" title="Direct link to heading">#</a></h2><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-1"></a>Step 1<a class="hash-link" href="#step-1" title="Direct link to heading">#</a></h4><p>Get consul and vault clients pointing to origin</p><p>Get consul and vault clients pointing to destinations</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-2"></a>Step 2<a class="hash-link" href="#step-2" title="Direct link to heading">#</a></h4><p>Check if we could read, write, update, delete in origin consul kv under origin and destination sync paths</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-3"></a>Step 3<a class="hash-link" href="#step-3" title="Direct link to heading">#</a></h4><p>Check if we could read in origin vault under data paths specified in config</p><p>Check if we could read, write, update, delete in destination vault under data paths specified in config</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-4"></a>Step 4<a class="hash-link" href="#step-4" title="Direct link to heading">#</a></h4><p>Prepare an error channel through which anyone under sync cycle can contact to throw errors</p><p>We also need to listen to error channel and check if the error at hand is fatal or not.</p><p>If not fatal, log the error with as much context available.
If fatal, stop the current sync cycle cleanly and future cycles. Log the error, inform a human, halt the program.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-5"></a>Step 5<a class="hash-link" href="#step-5" title="Direct link to heading">#</a></h4><p>Prepare an signal channel through which OS can send halt signals. Useful for humans to stop the whole sync program cleanly stop.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-7"></a>Step 7<a class="hash-link" href="#step-7" title="Direct link to heading">#</a></h4><p>Prepare a consul watch on origin sync index so whenever there is a change in consul index change we can run destination cycle</p><p>As a backup to consul watch, we also have a ticker initialized for interval (default: 1m) to run destination cycle</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-6"></a>Step 6<a class="hash-link" href="#step-6" title="Direct link to heading">#</a></h4><p>A ticker is initialized for an interval (default: 1m) to start the sync cycle.
The trigger will be starting point for one cycle.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-7-1"></a>Step 7<a class="hash-link" href="#step-7-1" title="Direct link to heading">#</a></h4><p>Transformers are initialized as a stack, bottom most are from default pack, top ones are from config file.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="cycle"></a>Cycle<a class="hash-link" href="#cycle" title="Direct link to heading">#</a></h2><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-0"></a>Step 0<a class="hash-link" href="#step-0" title="Direct link to heading">#</a></h4><p>A timer with timeout (default: 5m) will be created for every sync cycle. If workers get struck inbetween or something happens we do not halt vsync. Instead we wait till the timeout and kill everything created for current sync cycle. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-1-1"></a>Step 1<a class="hash-link" href="#step-1-1" title="Direct link to heading">#</a></h4><p>If triggered either via origin consul watch or ticker, we get origin sync info and destination sync info</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-2-1"></a>Step 2<a class="hash-link" href="#step-2-1" title="Direct link to heading">#</a></h4><p>Compare the infos from origin and destination.</p><p>Comparison starts basics like number of buckets then moves on to do index matching.</p><p>If index of a specific bucket is different between origin and destination, then we assume that bucket&#x27;s contains are not changed.</p><p>If index of a specific bucket is changed between origin and destination, then we check each key value pair in that bucket map.</p><p>Origin is the source of truth and has more priority in solving differences in comparison.</p><p>For every secret we first check version and type then updated time to make sure we update destinations based on changes from origin</p><blockquote><p>Edge Case:
User at origin has deleted the meta information, so it resets version numbers. User has also updated a new secret in same path, same number of times to match the version as old secret. In that case, the updated time will differ; hence we should be able to sync new changes</p></blockquote><p>The output of comparison will be 3 lists [addTask, updateTask, deleteTask] which can be given for workers to fetch from origin and save to destination. </p><p>We have effectively zeroed redundent copying of unaltered secrets.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-3-1"></a>Step 3<a class="hash-link" href="#step-3-1" title="Direct link to heading">#</a></h4><p>We create multiple worker go routines (default: 1). Each worker will fetch secret from origin and save in destination. </p><p>Each routine will be given:</p><ul><li>vault client pointing to origin</li><li>vault client pointing to destination</li><li>pack of tranformers</li><li>shared sync info</li><li>error channel</li><li>multiple origin absolute paths but one at a time</li></ul><p>sync info needs be safe for concurrent usage</p><p>Each worker</p><ol><li>will call origin vault for secret data</li><li>transform the path for destination if necessary</li><li>save the secret in destination under new path</li><li>copy the origin sync info for that secret to destination sync info. The reason for copying origin and not saving destination metainfo as such, is we need to compare origin and destination sync infos in future cycles</li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-4-1"></a>Step 4<a class="hash-link" href="#step-4-1" title="Direct link to heading">#</a></h4><p>Create 1 go routine to handle saving info to consul</p><ul><li>if cycle is successful, save consul sync info</li><li>if cycle has failed, abort saving info because it will corrupt existing sync info</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-5-1"></a>Step 5<a class="hash-link" href="#step-5-1" title="Direct link to heading">#</a></h4><p>From the list of absolute paths from comparison, send one path to next available worker. Once we have sent all the paths, wait for all worker go routines to complete their work.</p><p>The sender needs to be in separate routine, because we need to stop sending work to worker if we get halt signals.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-6-1"></a>Step 6<a class="hash-link" href="#step-6-1" title="Direct link to heading">#</a></h4><p>Reindex the destination sync info, for generating index info for each bucket.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_prK2" id="step-7-2"></a>Step 7<a class="hash-link" href="#step-7-2" title="Direct link to heading">#</a></h4><p>If everything is successful, send save signal for saving info ( index and buckets ) to destination consul.</p><p>If the cycle is aborted by signal, do not send the save signal for saving.</p><p>We need to cleanly close the cycle. Log appropriate cycle messages.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/ExpediaGroup/vsync/edit/master/website/docs/internals/destination.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2LL7"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/vsync/docs/internals/origin"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Origin</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/vsync/docs/faq/general"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">General Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_2xL- thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#startup" class="table-of-contents__link">Startup</a></li><li><a href="#cycle" class="table-of-contents__link">Cycle</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Expedia, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/vsync/styles.9dba2727.js"></script>
<script src="/vsync/runtime~main.1cf8b1d1.js"></script>
<script src="/vsync/main.0097cd37.js"></script>
<script src="/vsync/1.ef082d72.js"></script>
<script src="/vsync/2.3ecc4623.js"></script>
<script src="/vsync/21.7471a55b.js"></script>
<script src="/vsync/22.f690dbb4.js"></script>
<script src="/vsync/935f2afb.e5a0c5fa.js"></script>
<script src="/vsync/17896441.e63cd7f8.js"></script>
<script src="/vsync/9683d63b.8fa0e549.js"></script>
</body>
</html>